# 构建模型

## 流程

### **1. 加载数据集**



## 划分训练集、测试集、验证集的方法

### **1. 数据划分的核心思路**
- **目标**：训练模型捕捉未发生火灾社区（标签0）的“正常”模式，检测潜在隐患（异常点）。
- **关键挑战**：标签0样本（1164个）远多于标签1样本（61个），需合理利用有限的标签1样本评估模型对隐患的识别能力。

---

### **2. 具体划分方案**
#### **(1) 训练集**
- **用途**：仅包含标签0的样本，用于训练模型学习“正常社区”的分布。
- **比例建议**：随机抽取 **80%的标签0样本**（约1164×0.8≈931个）。
- **注意事项**：确保训练数据不包含任何标签1样本，避免污染正常模式学习。

#### **(2) 验证集**
- **用途**：调整模型参数（如 `nu`, `gamma`），评估对隐患的敏感性和误报率。
- **组成建议**：
  - **剩余20%的标签0样本**（1164-931≈233个）。
  - **随机抽取30%的标签1样本**（61×0.3≈18个）作为已知隐患。
- **注意事项**：验证集需包含少量标签1样本，帮助选择能识别隐患的模型参数。

#### **(3) 测试集**
- **用途**：最终评估模型性能，模拟真实场景下的隐患检测能力。
- **组成建议**：
  - **所有未使用的标签0样本**（若验证集已用完剩余标签0样本，可复用部分标签0样本，需确保无重叠）。
  - **剩余70%的标签1样本**（61-18≈43个）作为真实隐患。
- **注意事项**：测试集应完全独立于训练和验证过程，避免数据泄漏。

---

### **3. 代码示例（Python）**
```python
import numpy as np
from sklearn.model_selection import train_test_split

# 假设 X_0 是标签0的特征矩阵，X_1 是标签1的特征矩阵
# 划分训练集（标签0）
X0_train, X0_test_valid = train_test_split(X_0, test_size=0.2, random_state=42)

# 划分验证集和测试集中的标签0
X0_val, X0_test = train_test_split(X0_test_valid, test_size=0.5, random_state=42)

# 划分标签1样本用于验证和测试
X1_val, X1_test = train_test_split(X_1, test_size=0.7, random_state=42)

# 合并验证集和测试集
X_val = np.concatenate([X0_val, X1_val])
y_val = np.concatenate([np.zeros(len(X0_val)), np.ones(len(X1_val))])

X_test = np.concatenate([X0_test, X1_test])
y_test = np.concatenate([np.zeros(len(X0_test)), np.ones(len(X1_test))])
```

---

### **4. 关键注意事项**
1. **类别不平衡处理**：标签1样本极少，需通过分层抽样确保验证/测试集中包含足够隐患样本。
2. **评估指标选择**：
   - **召回率（Recall）**：模型对真实隐患（标签1）的识别能力。
   - **误报率（False Positive Rate）**：将正常社区误判为隐患的比例。
   - **F1 Score**：平衡召回率和精确率的综合指标。
3. **模型调参**：通过验证集的标签1样本优化 `nu`（控制异常点比例）和核函数参数。
4. **重复实验**：因数据量小，建议多次随机划分取平均结果，增强稳定性。

---

### **5. 潜在优化方向**
- **半监督学习**：若部分标签0社区实际存在隐患（但未被标记），可结合少量人工审核优化标签。
- **特征工程**：分析火灾相关特征（如电路老化率、消防通道密度），提升隐患检测可解释性。

---

## 划分训练集、测试集、验证集的依据

### **1. 单分类任务的特殊性**
单分类模型（如 One-Class SVM）的目标是**从正常数据（标签0）中学习分布规律**，将偏离此分布的样本视为异常（隐患）。因此：
- **训练集必须仅包含标签0样本**，避免污染正常模式的学习。
- **验证集和测试集需包含少量标签1样本**（已知隐患），用于评估模型对隐患的敏感性和误报率。

---

### **2. 关键考量维度**
#### **(1) 标签1样本的稀缺性**
- **标签1样本仅有61个**，远少于标签0样本（1164个）。
- **目标**：最大化利用标签1样本评估模型性能，避免因划分比例不当导致验证/测试集中隐患样本过少。
- **策略**：
  - 将标签1样本**优先分配给验证集和测试集**（而非训练集）。
  - 采用 **30%（验证集） + 70%（测试集）** 的划分，确保测试集有足够隐患样本（43个）进行最终评估。

#### **(2) 标签0样本的充足性**
- 标签0样本足够多（1164个），常规的 **80%（训练） + 20%（验证/测试）** 划分可行。
- **训练集需足够大**：80%的标签0样本（约931个）能充分学习正常社区的特征分布。
- **剩余20%的标签0样本**（233个）用于验证和测试，模拟真实场景中的“未知正常社区”。

#### **(3) 验证集与测试集的分工**
- **验证集**：需同时包含标签0和少量标签1样本（如18个），用于调参（如 `nu`, `gamma`），平衡召回率（隐患识别能力）与误报率。
- **测试集**：完全独立于训练和验证过程，需包含更多标签1样本（43个）以可靠评估泛化性能。

---

### **3. 比例设计的数学验证**
#### **(1) 标签1样本的分布**
- 验证集：`61 × 30% ≈ 18` 个标签1样本。
- 测试集：`61 × 70% ≈ 43` 个标签1样本。
- **合理性**：测试集的标签1样本足够计算召回率（如模型检测到30个隐患中的20个，召回率为66.7%），避免因样本过少导致指标波动。

#### **(2) 标签0样本的分布**
- 训练集：`1164 × 80% ≈ 931` 个。
- 验证集：`1164 × 20% × 50% ≈ 117` 个。
- 测试集：`1164 × 20% × 50% ≈ 117` 个。
- **合理性**：验证/测试集中的正常社区样本足够计算误报率（如模型误判117个中的10个，误报率为8.5%）。

#### **(3) 平衡评估指标的可信度**
- 若验证/测试集的标签1样本过少（如仅5个），召回率的置信区间会大幅波动（如检测到3个，召回率60%±40%），结果不可靠。
- 当前划分下，测试集43个标签1样本可使指标更稳定（如检测到30个，召回率70%±10%）。

---

### **4. 对比其他可能的划分方案**
#### **(1) 极端方案1：所有标签1样本给测试集**
- **问题**：验证集无标签1样本，无法调参优化模型对隐患的敏感性。
- **结果**：模型可能在测试集表现随机，无法可靠识别隐患。

#### **(2) 极端方案2：均匀分配标签1样本（如验证/测试各50%）**
- **问题**：测试集仅30个标签1样本，指标波动仍较大。
- **改进方向**：适当增加测试集比例（如70%）更合理。

#### **(3) 加入交叉验证（Cross-Validation）**
- **可行性**：由于标签1样本极少（61个），k-fold交叉验证会导致每折的标签1样本更少（如5-fold每折约12个），指标可能不稳定。
- **建议**：当前固定划分更适合小样本场景，可配合多次随机划分取平均值。

---

### **5. 实际落地建议**
- **多次随机划分取平均**：由于标签1样本稀缺，单次划分可能引入偏差，建议重复实验（如5次随机划分）并统计指标均值和方差。
- **特征重要性分析**：结合模型输出的特征权重，识别火灾隐患的核心影响因素（如电路老化、消防通道堵塞等），提升结果可解释性。

---

### **总结**
比例设计的核心是**优先保障模型对隐患（标签1）的识别能力**，同时充分利用标签0样本学习正常模式。通过权衡数据稀缺性、评估指标稳定性和模型调参需求，最终选择 **80%（训练）- 20%（验证/测试）** 的标签0划分和 **30%（验证）- 70%（测试）** 的标签1划分，以达到实际场景中的最优平衡。

## 关于特征选择

### **1. 是否需要特征选择？**
**需要优先进行特征选择**，原因如下：
1. **维度灾难**：46个特征在样本量较小（尤其是正样本仅61个）时，容易导致模型过拟合或计算效率低下。
2. **噪声过滤**：部分特征可能与火灾隐患无关（如社区绿化率），甚至包含冗余信息（如“人口密度”与“夜间人口数”高度相关）。
3. **可解释性**：特征选择能帮助识别关键隐患因素（如电路老化程度、消防通道宽度），为防灾提供明确指导。

---

### **2. 特征选择的核心策略**
#### **(1) 无监督特征选择（仅使用标签0样本）**
- **适用场景**：严格遵循单分类SVM的无监督设定，避免数据泄漏。
- **常用方法**：
  - **方差阈值法**：去除方差接近0的特征（如所有社区的“消防栓数量”均为10，无区分度）。
  - **相关性分析**：计算特征间相关系数，保留每组高相关特征中的一个（如保留“电路老化率”，删除“电路使用年限”）。
  - **聚类分析**：通过特征聚类合并相似特征。

#### **(2) 半监督特征选择（结合标签0和标签1样本）**
- **适用场景**：允许利用少量标签1样本（火灾社区）辅助筛选关键特征。
- **常用方法**：
  - **统计检验**：使用卡方检验、T检验等，对比标签0和标签1样本的特征分布差异，保留显著差异的特征。
  - **监督模型特征重要性**：用随机森林/XGBoost在完整数据（标签0+1）上训练，提取特征重要性排序。
  - **Wrapper方法**：通过递归特征消除（RFE），结合标签1样本优化特征子集。

---

### **3. 具体操作步骤**
#### **步骤1：无监督初筛（仅用训练集的标签0样本）**
- **目标**：快速去除明显冗余或无关特征。
- **方法**：
  1. 计算各特征的方差，删除方差低于阈值的特征（如保留方差前30名）。
  2. 计算特征间相关系数矩阵，若两个特征相关系数 >0.9，随机删除一个。
- **示例**：
  ```python
  from sklearn.feature_selection import VarianceThreshold
  from sklearn.datasets import load_breast_cancer

  # 假设 X_train 是训练集的标签0样本
  selector = VarianceThreshold(threshold=0.1)  # 调整阈值
  X_train_reduced = selector.fit_transform(X_train)
  ```

#### **步骤2：半监督精选（可选，需谨慎防止数据泄漏）**
- **目标**：利用标签1样本增强特征区分度。
- **方法**：
  1. 使用标签0（训练集）和标签1（验证集）样本，进行两独立样本T检验，保留p值<0.05的特征。
  2. 训练随机森林分类器（标签0 vs. 标签1），按特征重要性排序选择Top-K特征。
- **示例**：
  ```python
  from sklearn.ensemble import RandomForestClassifier

  # 合并训练集标签0和验证集标签1（确保不包含测试集）
  X_temp = np.concatenate([X_train, X_val[y_val == 1]])
  y_temp = np.concatenate([np.zeros(len(X_train)), np.ones(sum(y_val == 1))])

  model = RandomForestClassifier()
  model.fit(X_temp, y_temp)
  importance = model.feature_importances_
  selected_features = importance.argsort()[-15:]  # 保留前15个重要特征
  ```

#### **步骤3：模型验证与迭代**
- **目标**：验证特征选择对模型性能的影响。
- **方法**：
  1. 分别训练One-Class SVM（原始特征 vs. 筛选后特征）。
  2. 比较验证集的召回率（标签1样本检测率）和误报率（标签0样本误判率）。
  3. 选择召回率高且误报率可接受的特征子集。

---

### **4. 关键注意事项**
1. **数据泄漏风险**：
   - 若使用标签1样本辅助特征选择，需确保仅使用验证集的标签1样本，且测试集完全隔离。
   - 推荐先完成无监督初筛，再在验证集上评估是否需要半监督精选。

2. **特征可解释性**：
   - 优先选择物理意义明确的特征（如“消防通道堵塞次数”而非主成分得分），便于后续隐患整改。

3. **模型兼容性**：
   - One-Class SVM对特征尺度敏感，需在特征选择后标准化数据（如Z-Score归一化）。

---

### **5. 替代方案：特征降维（PCA）**
- **适用场景**：特征高度线性相关且可解释性要求较低。
- **方法**：
  ```python
  from sklearn.decomposition import PCA
  from sklearn.preprocessing import StandardScaler

  scaler = StandardScaler()
  X_train_scaled = scaler.fit_transform(X_train)
  pca = PCA(n_components=0.95)  # 保留95%方差
  X_train_pca = pca.fit_transform(X_train_scaled)
  ```

---

### **6. 最终建议**
1. **必做无监督初筛**：至少通过方差阈值和相关性分析减少10-20个冗余特征。
2. **谨慎尝试半监督精选**：若验证集标签1样本足够（≥15个），可用统计检验或随机森林精选5-10个关键特征。
3. **避免过度降维**：特征数建议保持在10-20之间，平衡模型复杂度和可解释性。

通过合理特征选择，模型可更聚焦于火灾隐患的核心指标（如电路负荷、消防设施密度），提升隐患检测的准确性和可操作性。
